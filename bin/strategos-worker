#!/bin/bash
#
# Strategos Worker CLI
#
# Usage:
#   strategos-worker list          - List all workers
#   strategos-worker spawn <path>  - Spawn a new worker
#   strategos-worker stop <id>     - Stop a worker
#   strategos-worker output <id>   - Get worker output
#   strategos-worker send <id>     - Send input to worker

set -e

# Configuration
STRATEGOS_PORT="${PORT:-38007}"
API_URL="http://localhost:$STRATEGOS_PORT/api"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check if server is running
check_server() {
    if ! curl -s "$API_URL/health" > /dev/null 2>&1; then
        echo -e "${RED}Error: Strategos server is not running${NC}"
        echo "Start it with: strategos start"
        exit 1
    fi
}

# List all workers
list_workers() {
    check_server

    echo -e "${BLUE}Active Workers${NC}"
    echo "=============="

    local workers=$(curl -s "$API_URL/workers")

    if [ "$workers" = "[]" ]; then
        echo -e "${YELLOW}No workers running${NC}"
        return
    fi

    # Pretty print with basic formatting
    echo "$workers" | python3 -c "
import sys, json
workers = json.load(sys.stdin)
for w in workers:
    status_color = '\\033[32m' if w.get('status') == 'running' else '\\033[33m'
    print(f\"{status_color}{w.get('id', 'N/A'):8}\\033[0m {w.get('label', 'N/A'):30} {w.get('status', 'N/A'):10} {w.get('project', 'N/A')}\")
" 2>/dev/null || echo "$workers"
}

# Spawn a new worker
spawn_worker() {
    check_server

    local project_path="$1"
    local label="$2"
    local provider="$3"

    if [ -z "$project_path" ]; then
        echo -e "${RED}Error: Project path is required${NC}"
        echo "Usage: strategos-worker spawn <path> [label] [provider]"
        exit 1
    fi

    # Resolve to absolute path
    project_path=$(cd "$project_path" 2>/dev/null && pwd || echo "$project_path")

    echo -e "${BLUE}Spawning worker in $project_path...${NC}"

    local body="{\"projectPath\": \"$project_path\""
    [ -n "$label" ] && body="$body, \"label\": \"$label\""
    [ -n "$provider" ] && body="$body, \"provider\": \"$provider\""
    body="$body}"

    local response=$(curl -s -X POST "$API_URL/workers" \
        -H "Content-Type: application/json" \
        -d "$body")

    local worker_id=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))" 2>/dev/null)

    if [ -n "$worker_id" ]; then
        echo -e "${GREEN}Worker spawned successfully${NC}"
        echo "  ID: $worker_id"
        echo "  Label: ${label:-$project_path}"
        echo ""
        echo "Commands:"
        echo "  strategos-worker output $worker_id    # View output"
        echo "  strategos-worker send $worker_id      # Send input"
        echo "  strategos-worker stop $worker_id      # Stop worker"
    else
        echo -e "${RED}Failed to spawn worker${NC}"
        echo "$response"
        exit 1
    fi
}

# Stop a worker
stop_worker() {
    check_server

    local worker_id="$1"

    if [ -z "$worker_id" ]; then
        echo -e "${RED}Error: Worker ID is required${NC}"
        echo "Usage: strategos-worker stop <id>"
        exit 1
    fi

    echo -e "${BLUE}Stopping worker $worker_id...${NC}"

    local response=$(curl -s -X DELETE "$API_URL/workers/$worker_id")

    if echo "$response" | grep -q '"success":true'; then
        echo -e "${GREEN}Worker stopped${NC}"
    else
        echo -e "${RED}Failed to stop worker${NC}"
        echo "$response"
        exit 1
    fi
}

# Get worker output
get_output() {
    check_server

    local worker_id="$1"
    local follow="$2"

    if [ -z "$worker_id" ]; then
        echo -e "${RED}Error: Worker ID is required${NC}"
        echo "Usage: strategos-worker output <id> [--follow]"
        exit 1
    fi

    if [ "$follow" = "--follow" ] || [ "$follow" = "-f" ]; then
        echo -e "${BLUE}Following output for worker $worker_id (Ctrl+C to stop)${NC}"
        echo ""

        while true; do
            curl -s "$API_URL/workers/$worker_id/output" | \
                python3 -c "import sys, json; print(json.load(sys.stdin).get('output', ''))" 2>/dev/null
            sleep 1
        done
    else
        curl -s "$API_URL/workers/$worker_id/output" | \
            python3 -c "import sys, json; print(json.load(sys.stdin).get('output', ''))" 2>/dev/null
    fi
}

# Send input to worker
send_input() {
    check_server

    local worker_id="$1"
    local input="$2"

    if [ -z "$worker_id" ]; then
        echo -e "${RED}Error: Worker ID is required${NC}"
        echo "Usage: strategos-worker send <id> <input>"
        exit 1
    fi

    if [ -z "$input" ]; then
        echo -e "${CYAN}Enter input (Ctrl+D to send):${NC}"
        input=$(cat)
    fi

    echo -e "${BLUE}Sending input to worker $worker_id...${NC}"

    local response=$(curl -s -X POST "$API_URL/workers/$worker_id/input" \
        -H "Content-Type: application/json" \
        -d "{\"input\": $(echo "$input" | python3 -c 'import sys, json; print(json.dumps(sys.stdin.read()))')}")

    if echo "$response" | grep -q '"success":true'; then
        echo -e "${GREEN}Input sent${NC}"
    else
        echo -e "${RED}Failed to send input${NC}"
        echo "$response"
        exit 1
    fi
}

# Get worker details
get_worker() {
    check_server

    local worker_id="$1"

    if [ -z "$worker_id" ]; then
        echo -e "${RED}Error: Worker ID is required${NC}"
        exit 1
    fi

    curl -s "$API_URL/workers/$worker_id" | python3 -m json.tool 2>/dev/null || \
        curl -s "$API_URL/workers/$worker_id"
}

# Get worker summary
get_summary() {
    check_server

    local worker_id="$1"

    if [ -z "$worker_id" ]; then
        echo -e "${RED}Error: Worker ID is required${NC}"
        exit 1
    fi

    echo -e "${BLUE}Getting AI summary for worker $worker_id...${NC}"
    curl -s "$API_URL/workers/$worker_id/summary" | python3 -m json.tool 2>/dev/null || \
        curl -s "$API_URL/workers/$worker_id/summary"
}

help() {
    echo "Strategos Worker CLI"
    echo ""
    echo "Usage: strategos-worker <command> [options]"
    echo ""
    echo "Commands:"
    echo "  list                    List all workers"
    echo "  spawn <path> [label]    Spawn a new worker in the given directory"
    echo "  stop <id>               Stop a worker"
    echo "  output <id> [-f]        Get worker output (-f to follow)"
    echo "  send <id> [input]       Send input to a worker"
    echo "  get <id>                Get worker details"
    echo "  summary <id>            Get AI-generated summary of worker state"
    echo ""
    echo "Examples:"
    echo "  strategos-worker list"
    echo "  strategos-worker spawn ~/projects/myapp \"IMPL: Feature Work\""
    echo "  strategos-worker output abc123 --follow"
    echo "  strategos-worker send abc123 \"Write unit tests for auth.js\""
    echo ""
    echo "Environment Variables:"
    echo "  PORT    Server port (default: 38007)"
}

# Main command dispatch
case "${1:-help}" in
    list|ls)
        list_workers
        ;;
    spawn|new|create)
        spawn_worker "$2" "$3" "$4"
        ;;
    stop|kill|delete|rm)
        stop_worker "$2"
        ;;
    output|out|log)
        get_output "$2" "$3"
        ;;
    send|input|write)
        send_input "$2" "$3"
        ;;
    get|info|show)
        get_worker "$2"
        ;;
    summary)
        get_summary "$2"
        ;;
    help|-h|--help)
        help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        help
        exit 1
        ;;
esac
